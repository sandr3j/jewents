<!DOCTYPE html>
<html>

<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JSON Feed Viewer</title>

  <style>
    :root{--bg:#0f1724;--card:#0b1320;--muted:#9aa4b2;--accent:#7dd3fc}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:linear-gradient(180deg,#071126 0%, #071826 100%); color:#e6eef6}
    header{display:flex;align-items:center;gap:16px;padding:18px 20px;border-bottom:1px solid rgba(255,255,255,0.03)}
    header img{width:44px;height:44px;border-radius:8px;object-fit:cover}
    header h1{font-size:18px;margin:0}
    header p{margin:0;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center;margin-left:auto}
    .controls input[type=search]{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .controls select,.controls button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit}

    main{display:grid;grid-template-columns:360px 1fr;gap:20px;padding:20px}
    .sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:14px;border-radius:12px;min-height:400px}
    .sidebar h2{font-size:14px;margin:0 0 10px 0}
    .feed-meta{display:flex;gap:10px;align-items:center}
    .feed-meta img{width:56px;height:56px;border-radius:8px;object-fit:cover}
    .item-list{margin-top:12px;display:flex;flex-direction:column;gap:10px;max-height:64vh;overflow:auto;padding-right:6px}
    .item-card{display:flex;gap:10px;align-items:flex-start;padding:8px;border-radius:10px;background:rgba(255,255,255,0.01);cursor:pointer}
    .item-card img{width:72px;height:72px;border-radius:6px;object-fit:cover;flex-shrink:0}
    .item-card .meta{flex:1}
    .item-card .meta h3{margin:0;font-size:13px}
    .item-card .meta p{margin:4px 0 0 0;color:var(--muted);font-size:12px}

    .viewer{padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));min-height:60vh}
    .viewer .banner{width:100%;height:320px;border-radius:10px;overflow:hidden;background:#031026;display:flex;align-items:center;justify-content:center}
    .viewer .banner img{width:100%;height:100%;object-fit:cover}
    .viewer .content{margin-top:14px}
    .viewer h2{margin:10px 0}
    .meta-row{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:13px}
    .attachments{display:flex;gap:8px;margin-top:10px}
    .attachments img{width:120px;height:80px;object-fit:cover;border-radius:8px}

    footer{padding:14px 20px;color:var(--muted);font-size:13px}

    /* small screens */
    @media (max-width:900px){main{grid-template-columns:1fr;}
      .sidebar{order:2}
      .viewer{order:1}
      .viewer .banner{height:220px}}
  </style>

  
</head>
<body>
  <header>
    <img id="feedIcon" src="" alt="feed icon"/>
    <div>
      <h1 id="feedTitle">Feed</h1>
      <p id="feedDesc">JSON Feed viewer</p>
    </div>

    <div class="controls">
      <input id="search" type="search" placeholder="Search title / text" />
      <select id="sort">
        <option value="newest">Newest first</option>
        <option value="oldest">Oldest first</option>
      </select>
      <button id="downloadJson">Download JSON</button>
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <div class="feed-meta">
        <img id="feedBanner" src="" alt="banner">
        <div>
          <strong id="feedHome">home</strong>
          <div id="feedUrl" style="font-size:12px;color:var(--muted)"></div>
        </div>
      </div>

      <h2>Items</h2>
      <div class="item-list" id="itemList"></div>
    </aside>

    <section class="viewer" id="viewer">
      <div class="banner" id="viewerBanner">no preview</div>
      <div class="content">
        <div class="meta-row"><strong id="itemTitle">Select an item</strong><div style="flex:1"></div><div id="itemDate"></div></div>
        <div class="meta-row" style="margin-top:8px"><span id="itemExcerpt" style="color:var(--muted)"></span></div>
        <div class="attachments" id="attachments"></div>
        <div class="body" id="itemBody" style="margin-top:12px"></div>
        <div style="margin-top:14px;display:flex;gap:8px">
          <button id="openOriginal">Open original</button>
          <button id="copyLink">Copy link</button>
        </div>
      </div>
    </section>
  </main>

  <footer>Viewer generated locally · Locale: de-DE</footer>

  <script>
    let $div_ = document.querySelector('div');

/**
 * Get JSON data from an URL
 */
let getJSON = url => {
  return new Promise((resolve, reject) => {
    let xhr = new XMLHttpRequest();
    xhr.open('get', url, true);
    xhr.responseType = 'json';
    xhr.onload = () => {
      if (xhr.status === 200) resolve(xhr.response);
      else reject(xhr.status);
    };
    xhr.send();
  });
};

var FEED = "";

// ---------------- LOAD FEED FIRST ----------------
getJSON('https://jewents.pages.dev/json/')
  .then(data => {
    FEED = data;
    initFeed();  // ← start everything AFTER feed loads
  })
  .catch(status => {
    console.error('Error:', status);
  });

// --- Utils ---
const $ = sel => document.querySelector(sel);
const formatDate = (iso) => {
  try {
    const d = new Date(iso);
    return new Intl.DateTimeFormat('de-DE', {
      dateStyle: 'medium',
      timeStyle: 'short'
    }).format(d);
  } catch (e) { return iso }
}

// --- Render feed meta ---
function renderFeedMeta(feed) {
  $('#feedTitle').textContent = feed.title || 'Untitled feed';
  $('#feedDesc').textContent = feed.description || feed.language || '';
  $('#feedIcon').src = feed.icon || feed.favicon || '';
  $('#feedBanner').src = feed.icon || '';
  $('#feedHome').textContent = feed.home_page_url || '';
  $('#feedUrl').textContent = feed.feed_url || '';
}

// --- Item list & viewer ---
let currentItems = [];

function makeItemCard(item) {
  const el = document.createElement('div');
  el.className = 'item-card';

  const thumb = document.createElement('img');
  thumb.src = item.banner_image ||
    (item.attachments && item.attachments[0] && item.attachments[0].url) || '';
  thumb.alt = item.title || '';

  const meta = document.createElement('div');
  meta.className = 'meta';

  const h3 = document.createElement('h3');
  h3.textContent = item.title || '(no title)';

  const p = document.createElement('p');
  p.textContent = item._microfeed && item._microfeed.date_published_short
    ? item._microfeed.date_published_short
    : (item.date_published ? formatDate(item.date_published) : '');

  meta.appendChild(h3);
  meta.appendChild(p);

  el.appendChild(thumb);
  el.appendChild(meta);
  el.addEventListener('click', () => openItem(item));

  return el;
}

function renderList(items) {
  const list = $('#itemList');
  list.innerHTML = '';
  if (!items.length) {
    list.textContent = 'No items';
    return;
  }
  items.forEach(it => list.appendChild(makeItemCard(it)));
}

function openItem(item) {
  $('#itemTitle').textContent = item.title || '(no title)';
  $('#itemDate').textContent = item.date_published ? formatDate(item.date_published) : '';
  $('#itemExcerpt').textContent = (item.content_text || '').split('\n').slice(0, 3).join(' ') || '';

  // banner
  const bannerContainer = $('#viewerBanner');
  bannerContainer.innerHTML = '';
  const bannerUrl = item.banner_image ||
    (item.attachments && item.attachments[0] && item.attachments[0].url) || '';

  if (bannerUrl) {
    const img = document.createElement('img');
    img.src = bannerUrl;
    img.alt = item.title || '';
    bannerContainer.appendChild(img);
  } else {
    bannerContainer.textContent = 'no preview';
  }

  // attachments
  const at = $('#attachments');
  at.innerHTML = '';
  const attachments = item.attachments || [];
  attachments.forEach(a => {
    const i = document.createElement('img');
    i.src = a.url;
    i.title = a.mime_type || '';
    at.appendChild(i);
  });

  // body
  const body = $('#itemBody');
  if (item.content_html) {
    body.innerHTML = sanitizeHTML(item.content_html);
  } else {
    body.textContent = item.content_text || '';
  }

  // actions
  $('#openOriginal').onclick = () => {
    window.open(item._microfeed?.web_url || item.url || '#', '_blank');
  };

  $('#copyLink').onclick = async () => {
    const link = item._microfeed?.web_url || item.url || '';
    try {
      await navigator.clipboard.writeText(link);
      alert('Link copied');
    } catch (e) {
      prompt('Copy link', link);
    }
  };
}

// --- Sanitizer ---
function sanitizeHTML(html) {
  html = html.replace(/<(script|style)[\s\S]*?>[\s\S]*?<\/\1>/gi, '');
  html = html.replace(/\son[a-zA-Z]+=\"[\s\S]*?\"/gi, '');
  html = html.replace(/\son[a-zA-Z]+='[\s\S]*?'/gi, '');
  html = html.replace(/href=\"javascript:[^\"]*\"/gi, 'href="#"');
  return html;
}

// --- Search & sort ---
$('#search').addEventListener('input', () => applyFilters());
$('#sort').addEventListener('change', () => applyFilters());

function applyFilters() {
  const q = $('#search').value.trim().toLowerCase();
  const sort = $('#sort').value;

  let items = FEED.items ? [...FEED.items] : [];

  if (q) {
    items = items.filter(it =>
      (it.title || '').toLowerCase().includes(q) ||
      (it.content_text || '').toLowerCase().includes(q)
    );
  }

  items.sort((a, b) => {
    const ta = new Date(a.date_published || 0).getTime();
    const tb = new Date(b.date_published || 0).getTime();
    return sort === 'newest' ? tb - ta : ta - tb;
  });

  currentItems = items;
  renderList(items);
  if (items[0]) openItem(items[0]);
}

// --- Download JSON ---
$('#downloadJson').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(FEED, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'feed.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

// ---------------- INIT AFTER LOAD ----------------
function initFeed() {
  renderFeedMeta(FEED);
  currentItems = FEED.items ? [...FEED.items] : [];
  applyFilters();
}

  </script>
</body>
</html>
